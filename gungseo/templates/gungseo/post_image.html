{% extends 'gungseo/application.html' %}
{% block content %}

<h2><b>이미지 미리보기</b></h2>
<div class="upload_wrap">
	<p class="title">이미지 업로드</p>
  <form method="post" action={% url 'result' %} enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ form.as_p}}
    <div class="hidden_submit">
      <input id="x1" type="hidden" name="x1">
      <input id="y1" type="hidden" name="y1">
      <input id="x2" type="hidden" name="x2">
      <input id="y2" type="hidden" name="y2">
    </div>
  	<div class="preview_wrap">
      	<img id="preview" />
    </div>
    <div class="icon">
     	<i class="fas fa-crop-alt"></i>
     	<i class="fas fa-hand-point-up"></i>
     	<i class="fas fa-times"></i>
     	<i class="fas fa-sync-alt"></i>
     	<button type="submit"><i class="fas fa-arrow-circle-right"></i></button>
    </div>
  </form>
</div>
<script type="text/javascript">
  //variable 선언
	var sel_file, target_image, resize_flag=false, crop_flag=false, upload_flag= false;
  var jcrop_api;
  var origin_w, origin_h;

	$(document).ready(function(){
    // 프리뷰숨기기
    $(".preview_wrap").hide();

		// imageUpload & preview
    $('.input_img').on('change', handleImgFileSelect);

		// image remove
		$(".fa-times").click(function(){
      if(crop_flag == true){
        jcrop_api.destroy();
        crop_flag = false;
      }
      if(resize_flag == true){
        $("#preview").resizable('destroy');
        $("#preview").height(300);
        $("#preview").width(300);
        resize_flag = false;
      }
      $("#preview").removeAttr('src');
			$(".input_img").val("");
      $(".input_img").show();
      $(".preview_wrap").hide();
      upload_flag = false;
    });
    // image resizing
    $(".fa-hand-point-up").click(function(){
      if(crop_flag == true){
        crop_flag = false;
        jcrop_api.destroy();
      }
      resize_flag = true;
      $( "#preview" ).resizable({
         handles : 'n,e,s,w',
         containment: ".preview_wrap"});
    });
    // image crop
    $(".fa-crop-alt").click(function(){
      if(crop_flag == false && upload_flag == true){
        crop_flag = true;
        $("#preview").Jcrop({
          onChange: updateCoords,
          onSelect: updateCoords,
          bgOpacity: 0.5,
          setSelect: [100,100,200,200]
        },function(){jcrop_api = this;});
      }
    });
    // image refreshing
    $("#preview").attr("src", target_image);
    $(".input_img").val(target_image);

    $(".fa-sync-alt").click(function(){
      if(crop_flag == true){
        // 전달하는 x1,x2,y1,y2좌표를 초기화해서 전달하는 방법으로 하기
        $("#x1").val(0);
        $("#y1").val(0);
        $("#x2").val(origin_w);
        $("#y2").val(origin_h);  
        jcrop_api.destroy();
        crop_flag = false;
      }
      if(resize_flag == true){
        $("#preview").resizable('destroy');
        $("#preview").height(300).width(300).css({
           "position" : "relative",
           "top" : "0px",
           "left" : "0px"
        });}
    });
	})

	function handleImgFileSelect(e){
		var files = e.target.files;
		var filesArr = Array.prototype.slice.call(files);
		filesArr.forEach(function(f){
			if(!f.type.match("image.*")){
				alert("확장자는 이미지 확장자만 가능합니다.");
				return;
			}
			sel_file = f;
			var reader = new FileReader();
			reader.onload = function(e){
        target_image = new Image();
        target_image.src = e.target.result;
				$("#preview, img.jcrop-preview, .jcrop-holder img").attr("src", target_image.src); 
        $(".input_img").hide();
        $(".preview_wrap").show();
        target_image.onload = function() {
            origin_w = this.width;
            origin_h = this.height
            $("#x1").val(0);
            $("#y1").val(0);
            $("#x2").val(origin_w);
            $("#y2").val(origin_h);  
        };
        upload_flag = true;
			}
			reader.readAsDataURL(f);


		});
	}

  function updateCoords(c){
    var x1, y1, x2, y2;
    var img_w = $('#preview').width(), img_h= $('#preview').height();
    var ratioX= origin_w/img_w, ratioY= origin_h/img_h;

    x1 = Math.round(c.x * ratioX);
    y1 = Math.round(c.y * ratioY);
    x2 = Math.round(c.x2 * ratioX);
    y2 = Math.round(c.y2 * ratioY);

    $("#x1").val(x1);
    $("#y1").val(y1);
    $("#x2").val(x2);
    $("#y2").val(y2);

    console.log("x1 :"+x1+" y1 :"+y1+" x2 "+x2+" y2: "+y2);
  }
</script>
{% endblock %} 
