{% extends 'gungseo/application.html' %}
{% block content %}

<h2><b>이미지 미리보기</b></h2>
<div class="upload_wrap">
	<p class="title">이미지 업로드</p>
  <form method="post" action={% url 'result' %} enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ form.as_p}}
  	<div class="preview_wrap">
      	<img id="preview" />
    </div>
    <div class="icon">
     	<i class="fas fa-crop-alt"></i>
     	<i class="fas fa-hand-point-up"></i>
     	<i class="fas fa-times"></i>
     	<i class="fas fa-sync-alt"></i>
     	<button type="submit"><i class="fas fa-arrow-circle-right"></i></button>
    </div>
    <div class="hidden_submit">
      <input id="x" type="hidden" name="x">
      <input id="y" type="hidden" name="y">
      <input id="w" type="hidden" name="w">
      <input id="h" type="hidden" name="h">
    </div>
  </form>
</div>
<script type="text/javascript">
  //variable 선언
	var sel_file, target, resize_flag=false, crop_flag=false, upload_flag= false;
  
  var jcrop_api, boundx, boundy;

	$(document).ready(function(){
    // 프리뷰숨기기
    $(".preview_wrap").hide();

		// imageUpload & preview
		$(".input_img").on("change", handleImgFileSelect);

		// image remove
		$(".fa-times").click(function(){
      if(crop_flag == true){
        jcrop_api.destroy();
        crop_flag = false;
      }
      if(resize_flag == true){
        $("#preview").resizable('destroy');
        $("#preview").height(300);
        $("#preview").width(300);
        resize_flag = false;
      }
      $("#preview").removeAttr('src');
			$(".input_img").val("");
      $(".input_img").show();
      $(".preview_wrap").hide();
      upload_flag = false;
    });
		
		// image refreshing
		$(".fa-sync-alt").click(function(){
      if(crop_flag == true){
        jcrop_api.destroy();
        crop_flag = false;
      }
      if(resize_flag == true){
        $("#preview").resizable('destroy');
        $("#preview").height(300);
        $("#preview").width(300);
      }
      $("#preview").attr("src", target);
      
    });
    // image resizing
    $(".fa-hand-point-up").click(function(){
      if(crop_flag == true){
        crop_flag = false;
        jcrop_api.destroy();
      }
      else{
        resize_flag = true;
        $( "#preview" ).resizable({
        containment: ".preview_wrap"});
      }
    });
    // image crop
    $(".fa-crop-alt").click(function(){
      if(crop_flag == false && upload_flag == true){
        crop_flag = true;
        $("#preview").Jcrop({
          onChange: updateCoords,
          onSelect: updateCoords,
          bgOpacity: 0.5,
          setSelect: [100,100,200,200]
        },function(){jcrop_api = this;});
      }
    });
	});

	function handleImgFileSelect(e){
		var files = e.target.files;
		var filesArr = Array.prototype.slice.call(files);
		filesArr.forEach(function(f){
			if(!f.type.match("image.*")){
				alert("확장자는 이미지 확장자만 가능합니다.");
				return;
			}
			sel_file = f;
			var reader = new FileReader();
			reader.onload = function(e){
        target = e.target.result;
				$("#preview, img.jcrop-preview, .jcrop-holder img .submit_img").attr("src", target);
        $(".input_img").hide();
        $(".preview_wrap").show();
        upload_flag = true;
			}
			reader.readAsDataURL(f);
		});
	}

  function updateCoords(c){
    var x, y, x2, y2;
    x = c.x;
    y = c.y;
    w = c.w;
    h = c.h;
    $("#x").val(x);
    $("#y").val(y);
    $("#w").val(w);
    $("#h").val(h);
    console.log("x :"+x+" y :"+y+" w: "+w+" h: "+h);
  }
</script>

<!-- 좌표값알아내기, 이미지크롭하면서 리사이징 -->
{% endblock %} 
